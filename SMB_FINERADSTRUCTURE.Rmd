---
title: "SMB_FINERADSTRUCTURE"
author: "Joe Gunn"
date: "11/12/2019"
output: html_document
---

## Libraries needed for analysis
```{r libraries, echo = FALSE, include=FALSE}
library(readxl)
library(tidyverse)
library(cowplot)
library(devtools)
library(SNPRelate)
library(vcfR)
library(pophelper)
library(PopGenome)
library(adegenet)
library(XML)
library(RColorBrewer)
source("../../R_packages/FinestructureLibrary.R") #Fine-structure R source code
```

# FineRADstructure Analyses
### haplotype files were produced using the hapsFromVCF on my vcf file, and coancestry matrics were produced using the RADpainter and finestructure commands. R code and figures were adapted from the fineRADstructurePlot.R and FinestructureLibrary.R libraries (Milan Malinski)
## Read in data output from fineRADstructure 
```{r}
#Finerad files for SMB samples only
chunkfile_all <- "../../raw_data/fineradstructure_data/hap_withfilters_chunks.out"
mcmcfile_all <- "../../raw_data/fineradstructure_data/hap_withfilters_chunks.mcmc.xml"
treefile_all <- "../../raw_data/fineradstructure_data/hap_withfilters_chunks.mcmcTree.xml"
```

## Set path name for depositing completed fineRADstructure figures
```{r}
### 2) EDIT THIS PATH TO WHERE YOU WANT THE PLOTS:
plotsFolder <- "../FINERADSTRUCTURE_analysis"
### 3) SET VALUES FOR THESE VARIABLES: "analysisName" will be included in output plots
analysisName <- "smb_coancestry" 
maxIndv <- 10000
maxPop <-10000
```

## Prepare color palette, 
```{r color palette, echo=FALSE}
my_palette <- colorRampPalette(c("white", "navyblue","deeppink2","black"))(n = 299)
```

## Prepare Plots for ALL SAMPLES

### I am  running the coancestry matrix for all samples, excluding spotted bass (sister species) and excluding the hybrid from ADMIXTURE analysis (see SMB_ADMIXTURE.Rmd)

## Prepare raw coancestry data and tree
```{r}
dataraw_all <- as.matrix(read.table(chunkfile_all, row.names=1, header=T, skip=1)) # read in the pairwise coincidence 

###### READ IN THE MCMC FILES
mcmcxml_all <- xmlTreeParse(mcmcfile_all) ## read into xml format
mcmcdata_all <- as.data.frame.myres(mcmcxml_all) ## convert this into a data frame

###### READ IN THE TREE FILES
treexml_all <- xmlTreeParse(treefile_all) ## read the tree as xml format
ttree_all <- extractTree(treexml_all) ## extract the tree into ape's phylo format

```

## Make files for coancestry plot and dendrogram
```{r}
## Reduce the amount of significant digits printed in the posteror assignment probabilities (numbers shown in the tree):
ttree_all$node.label[ttree_all$node.label!=""] <- format(as.numeric(ttree_all$node.label[ttree_all$node.label!=""]),digits=2)

 # convert to dendrogram format
tdend_all <- myapetodend(ttree_all, factor=1)
## Now we work on the MAP state
mapstate_all <- extractValue(treexml_all,"Pop") # map state as a finestructure clustering
mapstatelist_all <- popAsList(mapstate_all) # .. and as a list of individuals in populations
popnames_all <- lapply(mapstatelist_all, NameSummary) # population names IN A REVERSIBLE FORMAT (I.E LOSSLESS)
## NOTE: if your population labels don't correspond to the format we used (NAME<number>) YOU MAY HAVE TROUBLE HERE. YOU MAY NEED TO RENAME THEM INTO THIS FORM AND DEFINE YOUR POPULATION NAMES IN popnamesplot BELOW
popnamesplot_all <-lapply(mapstatelist_all, NameMoreSummary) # a nicer summary of the populations

names(popnames_all) <- popnamesplot_all # for nicety only
names(popnamesplot_all ) <- popnamesplot_all # for nicety only

popdend_all <- makemydend(tdend_all, mapstatelist_all) # use NameSummary to make popdend
popdend_all <- fixMidpointMembers(popdend_all) # needed for obscure dendrogram reasons
popdendclear_all <- makemydend(tdend_all, mapstatelist_all, "NameMoreSummary")# use NameMoreSummary to make popdend
popdendclear_all <- fixMidpointMembers(popdendclear_all) # needed for obscure dendrogram reasons

```

## Print fineRADstructure Plots
```{r}
## Plot 1: COANCESTRY MATRIX
fullorder_all <- labels(tdend_all) # the order according to the tree
datamatrix_all <- dataraw_all[fullorder_all, fullorder_all] # reorder the data matrix

tmpmat_all <- datamatrix_all
tmpmat_all[tmpmat_all > maxIndv] <- maxIndv #  # cap the heatmap

pdf("../FINERADSTRUCTURE_analysis/all_coancestry_matrix_betterlabels.pdf", height = 25, width = 25)

plotFinestructure(tmpmat_all, 
                  dimnames(tmpmat_all)[[1]], 
                  dend = tdend_all,
                  cols = my_palette, 
                  cex.axis = 1.5, 
                  edgePar = list(p.lwd = 0, 
                               t.srt = 1, 
                               t.off = -0.5, 
                               t.cex = 2))

dev.off()


## Plot 2: POPULATIONS AND COANCESTRY AVERAGES
popmeanmatrix_all <- getPopMeanMatrix(datamatrix_all, mapstatelist_all)

tmpmat_all <- popmeanmatrix_all
tmpmat_all[tmpmat_all > maxPop] <- maxPop # cap the heatmap

pdf("../FINERADSTRUCTURE_analysis/all_coancestry_matrix_averages_betterlabels.pdf", height = 20, width = 20)

plotFinestructure(tmpmat_all, 
                  dimnames(tmpmat_all)[[1]], 
                  dend = tdend_all, 
                  cols = my_palette, 
                  cex.axis = 1.5, 
                  edgePar = list(p.lwd = 0, 
                                 t.srt = 1, 
                                 t.off = -0.5, 
                                 t.cex = 2))

dev.off()


## Plot 3: POPULATIONS AND COANCESTRY AVERAGES WITH PERHAPS MORE INFORMATIVE LABELS
mappopcorrectorder_all <- NameExpand(labels(popdend_all))
mappopsizes_all <- sapply(mappopcorrectorder_all,length)
labellocs_all <- PopCenters(mappopsizes_all)
xcrt=0
ycrt=45

pdf("../FINERADSTRUCTURE_analysis/all_coancestry_matrix_averages_betterlabels_betterlabels.pdf", height = 25, width = 25)
 
plotFinestructure(tmpmat_all, 
                  dimnames(tmpmat_all)[[1]], 
                  labelsx=labels(popdendclear_all), 
                  labelsatx = labellocs_all, 
                  xcrt = xcrt, 
                  cols = my_palette, 
                  ycrt = ycrt, 
                  dend = tdend_all, 
                  cex.axis = 1.5, 
                  edgePar = list(p.lwd = 0, 
                               t.srt = 1, 
                               t.off = -0.5, 
                               t.cex = 2), 
                  hmmar = c(3,0,0,1))

dev.off()
```